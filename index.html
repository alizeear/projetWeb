<!DOCTYPE html>
<html ng-app="MusicPlayer" xmlns="http://www.w3.org/1999/html">
<header>
    <title>Music player</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="styles.css" />
</header>
    <body ng-controller="MusicPlayerController as mpCtrl">
    <header>
        <h1>Lecteur de musique collaboratif</h1>
        <h2>Langages et Technologies du Web 2</h2>
        <br/>
        <h3>Master IC²A WIC1/DCISS - UPMF Grenoble</h3>
    </header >
        <!--Le player graphique de deezer-->
        <div id="dz-root"></div>
        <div id="dz-player" style="width:100%; display: none" align="center"></div>
        <!--END player deezer-->

        <!--Player custom-->
        <section id="player">
            <table>
                <tr>
                    <td rowspan="2"><div ng-repeat="track in currentTrack" >
                        <img ng-src="{{track.album.cover}}">
                    </div></td>
                    <td colspan="2"> <div id="current_track_title" class="current_track"></div>
                </tr>
                <tr>
                    <td><div id="current_track_artist" class="current_artist"></div></td>

                </tr>
            </table>

                    <span class="glyphicon glyphicon-play" aria-hidden="true" onclick="DZ.player.play();return false;"></span>
                    <span class="glyphicon glyphicon-pause" aria-hidden="true" style="display: none;" onclick="DZ.player.pause();return false;"></span>
                    <div class="progress">
                        <div class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                        </div>
                    </div>
                    <!--<span class="glyphicon glyphicon-download" aria-hidden="true" onclick="Player();return false;"></span>-->
                    <div>
                        <span class="tooltip"></span> <!-- Tooltip -->
                        <div id="slider"></div> <!-- the Slider -->
                        <span class="volume"></span> <!-- Volume -->
                    </div>



            <!-- <div ng-repeat="track in currentTrack" >
                  <img ng-src="{{track.album.cover}}">
              </div>
              <span class="glyphicon glyphicon-play" aria-hidden="true" onclick="DZ.player.play();return false;"></span>
              <span class="glyphicon glyphicon-pause" aria-hidden="true" style="display: none;" onclick="DZ.player.pause();return false;"></span>
              <div class="progress">
                  <div class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                  </div>
              </div>
              <!--<span class="glyphicon glyphicon-download" aria-hidden="true" onclick="Player();return false;"></span>-->
            <!-- <div>
             <span class="tooltip"></span> <!-- Tooltip -->
            <!-- <div id="slider"></div> <!-- the Slider -->
            <!-- <span class="volume"></span> <!-- Volume -->
            <!--  </div>
             <div id="current_track_title" class="current_track"></div>
             <div id="current_track_artist" class="current_artist"></div>-->
            

            <!--<span class="glyphicon glyphicon-forward" aria-hidden="true" onclick="widget.playAction();" ng-click="musicPlayer.playNextTrack();"></span>-->
        </section>
        <!--END player custom-->
        <div class="col-md-7 col-md-offset-4">
        <section ng-controller="TabController as tab" ng-init="load()">
            <ul class="nav nav-pills">
                <li ng-class="{ active:tab.isSet(1) }">
                    <a href ng-click="tab.setTab(1)">Playlist</a>
                </li>
                <li ng-class="{ active:tab.isSet(2) }">
                    <a href ng-click="tab.setTab(2)">Catalogue</a>
                </li>
                <li ng-class="{ active:tab.isSet(3) }">
                    <a href ng-click="tab.setTab(3)">Search</a>
                </li>
            </ul>
            <!--  Playlist  -->
            <div ng-show="tab.isSet(1)" align="center">
                <h4>Playlist</h4>
                <table class="table">
                    <tr>
                        <th>Cover</th>
                        <th>Album</th>
                        <th>Morceau</th>
                        <th>Artiste</th>
                        <th>Durée</th>
                        <th>Vote</th>
                        <th></th>
                    </tr>
                    <tr ng-repeat="track in playlistDatas | orderBy: '-vote'" ng-init="id_song=$index">
                        <td><img ng-src="{{track.cover}}" class="image"></td>
                        <td>{{track.album}}</td>
                        <td>{{track.title}}</td>
                        <td>{{track.artist}}</td>
                        <td>{{track.duration/60 | number:0}}:{{track.duration%60}}</td>
                        <td>
                            <fieldset class="form-group">
                                <input type="submit" class="btn btn-primary" ng-click="vote(track.id, track.vote)" value="Voter" />
                            </fieldset>
                        </td>
                        <td>{{track.vote}}</td>
                    </tr>
                </table>
            </div>
            <!--  Catalogue  -->
            <div ng-show="tab.isSet(2)" align="center">
                <h4>Catalogue</h4>
                <table class="table">
                    <tr>
                        <th>Cover</th>
                        <th>Album</th>
                        <th>Morceau</th>
                        <th>Artiste</th>
                        <th>Durée</th>
                        <th>Ajouter à la playlist</th>
                    </tr>
                    <tr ng-repeat="data in catDatas track by data.id">
                        <td><img ng-src="{{data.album.cover}}" class="image"></td>
                        <td>{{data.album.title}}</td>
                        <td>{{data.title}}</td>
                        <td>{{data.artist.name}}</td>
                        <td>{{data.duration/60 | number:0}}:{{data.duration%60}}</td>
                        <td>
                            <fieldset class="form-group">
                                <input type="submit" class="btn btn-primary" ng-click="mpCtrl.addPlay($index)" value="Ajouter" />
                            </fieldset>
                        </td>
                    </tr>
                </table>
            </div>

            <!-- Search -->
            <div ng-show="tab.isSet(3)" align="center">
                <fieldset class="form-group">
                    <input ng-model="mpCtrl.search_text" ng-change="mpCtrl.search(search_text)" class="form-control" placeholder="Search for a song..." title="Search"/>
                </fieldset>
                <table class="table">
                    <tr>
                        <th>Cover</th>
                        <th>Album</th>
                        <th>Morceau</th>
                        <th>Artiste</th>
                        <th>Ajouter au catalogue</th>
                    </tr>
                    <tr ng-repeat="data in mpCtrl.datas.data">
                        <td><img ng-src="{{data.album.cover}}" class="image"></td>
                        <td>{{data.album.title}}</td>
                        <td>{{data.title}}</td>
                        <td>{{data.artist.name}}</td>
                        <td>
                            <fieldset class="form-group">
                                <input type="submit" class="btn btn-primary" ng-click="mpCtrl.addCat($index)" value="Ajouter" />
                            </fieldset>
                        </td>
                    </tr>
                </table>
            </div>
        </section>
        <script type="text/javascript" src="angular.min.js"></script>
        <script type="text/javascript" src="jquery-1.7.2.min.js"></script>
        <script type="text/javascript" src="jquery-ui-1.8.21.custom.min.js"></script>
    <script>
        $(function() {

            //Store frequently elements in variables
            var slider  = $('#slider'),
                    tooltip = $('.tooltip');

            //Hide the Tooltip at first
            tooltip.hide();

            //Call the Slider
            slider.slider({
                //Config
                range: "min",
                min: 1,
                value: 35,

                start: function(event,ui) {
                    tooltip.fadeIn('fast');
                },

                //Slider Event
                slide: function(event, ui) { //When the slider is sliding
                    DZ.player.setVolume(ui.value);
                    var value  = slider.slider('value'),
                            volume = $('.volume');

                    tooltip.css('left', value).text(ui.value);  //Adjust the tooltip accordingly

                    if(value <= 5) {
                        volume.css('background-position', '0 0');
                    }
                    else if (value <= 25) {
                        volume.css('background-position', '0 -25px');
                    }
                    else if (value <= 75) {
                        volume.css('background-position', '0 -50px');
                    }
                    else {
                        volume.css('background-position', '0 -75px');
                    };

                },

                stop: function(event,ui) {
                    tooltip.fadeOut('fast');
                }
            });

        });
    </script>
        <script type="text/javascript" src="app.js"></script>
        <script>
            var app = angular.module("MusicPlayer", []);
            app.controller('TabController', ['$http', function($http){
                var playlist = this;
                //playlist.tracks = [];
                playlist.tab = 1;
                playlist.isSet = function(checkTab) {
                    return this.tab === checkTab;
                }
                playlist.setTab = function(setTab) {
                    this.tab = setTab;
                };
            }]);
            app.controller('MusicPlayerController',['$http', '$scope', function($http, $scope){
                this.musicPlayer = new MusicPlayerRestClient();
                var that = this;
                DZ.player.setVolume(30);

                that.search_text = "";
                that.datas = { };
                //Fonction de recherche
                that.search = function(){
                    DZ.api('/search?q=' + that.search_text, function(response){
                        that.datas = response;
                    });
                };

                $scope.catDatas = [ ];
                //Fonction d'ajout de la recherche vers le catalogue
                that.addCat = function(index){
                    $http.put('http://localhost:3000/projetweb/tracks/catalogueTracks',
                            JSON.stringify({data: that.datas.data[index].id}),
                            {headers: { 'Content-Type': 'application/json'}}).
                            success(function(resp){
                                console.log(that.datas.data[index].id);
                                DZ.api('/track/' + resp, function(response){
                                    $scope.catDatas.push(response);
                                });
                                that.catSongs.push(resp);
                                //console.log("PUT successful : " + resp + " (addCat)");
                            }).
                            error(function(){
                                console.log("PUT failed");
                            });
                };

                that.catSongs = [ ];
                $scope.playlistDatas = [ ];
                //Fonction d'ajout du catalogue vers la playlist
                that.addPlay = function(index){
                    $http.get('http://localhost:3000/projetweb/tracks/catalogueTracks').
                            success(function(resp){
                                that.catSongs = resp;
                                //console.log("GET successful : " + that.catSongs + " (addPlay)");
                            }).
                            error(function(){
                                console.log("GET failed");
                            });

                    $http.put('http://localhost:3000/projetweb/tracks/allTracks',
                            JSON.stringify({id: that.catSongs[index], vote: 0}),
                            {headers: { 'Content-Type': 'application/json'}}).
                            success(function(resp){
                                DZ.api('/track/' + resp.id, function(response){
                                    var song = {id: response.id, cover: response.album.cover, album: response.album.title,
                                        title: response.title, artist: response.artist.name, duration: response.duration, vote: 0};
                                    $scope.playlistDatas.push(song);
                                    // on ajoute maintenant la track à la liste en cours de lecture
                                    DZ.player.addToQueue([resp.id]);
                                });
                                //console.log("PUT successful : " + resp + " (addPlay)");
                            }).
                            error(function(){
                                console.log("PUT failed");
                            });
                };
                //Fonction de chargement du catalogue au démmarage
                $scope.load = function(){
                    $http.get('http://localhost:3000/projetweb/tracks/catalogueTracks').
                            success(function(resp){
                                for(i = 0; i < resp.length; i++){
                                    DZ.api('/track/' + resp[i], function(response){
                                        $scope.catDatas.push(response);
                                    })
                                    that.catSongs.push(resp[i]);
                                }
                            }).
                            error(function(){
                                console.log("GET failed");
                            });
                };

                //Fonction de vote
                $scope.vote = function(id, vote){
                    $http.get('http://localhost:3000/projetweb/tracks/allTracks').
                            success(function(resp){
                                //console.log(resp);
                            }).
                            error(function(){
                                console.log("GET failed");
                            });
                    $http.put('http://localhost:3000/projetweb/tracks/allTracks',
                            JSON.stringify({id: id, vote: vote+1}),
                            {headers: { 'Content-Type': 'application/json'}}).
                            success(function(resp){
                                for(j = 0; j < $scope.playlistDatas.length; j++){
                                    if($scope.playlistDatas[j].id == id){
                                        $scope.playlistDatas[j].vote = vote+1;
                                    }
                                }
                            });
                };

                // Gestion de la progress bar
                DZ.Event.subscribe('player_position', function(arg) {
                    var pourcentage = (arg[0] / arg[1]) * 100;
                    $(".progress-bar").css('width', pourcentage + '%');
                })

                $scope.currentTrack = [];
                // Infos de la musique en cours de lecture
                DZ.Event.subscribe('current_track', function(arg) {

                    $("#current_track_title").text(arg.track.title);
                    $("#current_track_artist").text(arg.track.artist.name);

                    DZ.api('/track/' + arg.track.id, function (track) {
                        $scope.currentTrack = [];
                        $scope.currentTrack.push(track);
                        $scope.$apply();
                    })
                })

                // gestion de l'affichage des boutons play/pause
                that.isPlaying = false;

                DZ.Event.subscribe('player_play', function(arg) {
                    that.isPlaying = true;
                    console.log('play ! '+that.isPlaying);
                    $('.glyphicon-pause').show();
                    $('.glyphicon-play').hide();
                })

                DZ.Event.subscribe('player_paused', function(arg) {
                    that.isPlaying = false;
                    console.log('pause ! '+that.isPlaying);
                    $('.glyphicon-pause').hide();
                    $('.glyphicon-play').show();
                })


                this.myMusicPlayer = myMusicPlayer;

                // récupération de la playlist dans la BDD
                this.tracks = [ ];


                this.tracks = that.musicPlayer.getAllTrack();
                this.tracks = JSON.parse(this.tracks);
                this.tracks = this.tracks.data;
                // end

                that.tracksid = [ ];
                that.voteNB = [ ];
                for (i = 0; i < that.tracks.length; i++) {
                    that.tracksid[i] = that.tracks[i].id;
                    that.voteNB[i] = that.tracks[i].vote;
                    DZ.api('/track/' + that.tracksid[i], function (track) {
                        var song = {id: that.tracksid[i], cover: track.album.cover, album: track.album.title,
                            title: track.title, artist: track.artist.name, duration: track.duration, vote: that.voteNB[i]};
                        i++;
                        $scope.playlistDatas.push(song);
                    })

                }
                that.myMusicPlayer.tracks = this.tracksid;

                that.myMusicPlayer.play();

            }]);

            function MusicPlayer() {
                this.tracks = [];
                this.play = function(){
                    DZ.player.playTracks(this.tracks, 0,function(response){
                        //console.log("track list", response.tracks);
                    });
                }
            }
        </script>
        <script src="http://cdn-files.deezer.com/js/min/dz.js"></script>
        <script>
            DZ.init({
                appId  : 'YOUR_APP_ID',
                channelUrl : 'http://YOUR_DOMAIN/channel.html',
                player: {
                    container: 'dz-player',
                    width : 700,
                    height : 80,
                    onload : function(){
                        myMusicPlayer.play();
                    }
                }
            });
        </script>
        <script>
            function MusicPlayerRestClient(){
                var ALL_TRACKS_URI      = 'http://localhost:3000/projetweb/tracks/allTracks';

                this.getAllTrack = function(){
                    var allTracks = this.doRequest('GET', ALL_TRACKS_URI, null);
                    return allTracks;
                };

                this.doRequest = function(verb, url, data){
                    var response;
                    $.ajax({
                        url:  url,
                        type: verb,
                        data: data,
                        async: false,
                        success: function(resp) {
                            response = resp;
                        },
                        error: function(xhr) {
                            console.log("Error when " + verb + url);
                        }
                    });
                    return response;
                }; // method
            } // class

            var myMusicPlayer = new MusicPlayer();

        </script>
    </body>
</html>
